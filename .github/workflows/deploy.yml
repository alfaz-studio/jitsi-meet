name: Deploy

on:
    push:
        branches: [sonacove]
    pull_request:
        branches: [sonacove]

jobs:
    deploy:
        name: Cloudflare
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: true # Required for lib-jitsi-meet submodule

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: ".nvmrc"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build with Vite
              run: npm run build

            - name: Prepare deployment files
              run: |
                  # Move _redirects file to build root
                  # Vite automatically copies public/_redirects to build/meet/_redirects
                  # But Cloudflare expects it at build/_redirects (not build/meet/_redirects)
                  if [ -f build/meet/_redirects ]; then
                      cp build/meet/_redirects build/_redirects
                      echo "âœ… Copied _redirects to build root"
                  else
                      echo "âš ï¸ Warning: _redirects file not found in build output"
                  fi

            - name: Deploy to Production
              if: github.ref == 'refs/heads/sonacove' && github.event_name == 'push'
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  command: deploy
                  workingDirectory: "."
                  wranglerVersion: "3"

            - name: Deploy Preview Version
              if: github.event_name == 'pull_request'
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  command: versions upload
                  workingDirectory: "."
                  wranglerVersion: "3"
              id: preview-deploy

            - name: Save preview URL for test workflow
              if: github.event_name == 'pull_request'
              run: |
                  PREVIEW_URL="${{ steps.preview-deploy.outputs.deployment-url }}"
                  if [[ -n "$PREVIEW_URL" ]]; then
                      echo "$PREVIEW_URL" > preview-url.txt
                  else
                      echo "Preview deployment created but URL not available" > preview-url.txt
                  fi

            - name: Upload preview URL artifact
              if: github.event_name == 'pull_request'
              uses: actions/upload-artifact@v4
              with:
                  name: preview-url
                  path: preview-url.txt
                  retention-days: 1

            - name: Add deployment summary
              if: always()
              run: |
                  if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/sonacove" ]]; then
                      echo "**Deployment Type:** Production Deploy" >> $GITHUB_STEP_SUMMARY
                      echo "**Status:** âœ… Deployed to production" >> $GITHUB_STEP_SUMMARY
                      echo "::notice title=Production Deployment::ðŸš€ Deployed to production successfully"
                  elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
                      # Extract preview URL from wrangler output and add /meet subpath
                      PREVIEW_URL="${{ steps.preview-deploy.outputs.deployment-url }}"
                      if [[ -n "$PREVIEW_URL" ]]; then
                          PREVIEW_URL_WITH_MEET="${PREVIEW_URL}/meet/testmeeting1"
                          echo "**Preview URL:** [$PREVIEW_URL_WITH_MEET]($PREVIEW_URL_WITH_MEET)" >> $GITHUB_STEP_SUMMARY
                          echo "::notice title=Preview Deployment::ðŸš€ Preview deployed: $PREVIEW_URL_WITH_MEET"
                      else
                          echo "**Preview URL:** Preview deployment created" >> $GITHUB_STEP_SUMMARY
                          echo "::notice title=Preview Deployment::ðŸš€ Preview deployment created successfully"
                      fi
                      echo "**Deployment Type:** Version Upload" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Update PR comment with preview
              if: github.event_name == 'pull_request'
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: preview-deployment
                  message: |
                      ## ðŸš€ Preview Deployment

                      **Status:** âœ… Successfully deployed
                      **Deployment Type:** Version Upload
                      **Preview URL:** ${{ steps.preview-deploy.outputs.deployment-url && format('[{0}/meet/testmeeting1]({0}/meet/testmeeting1)', steps.preview-deploy.outputs.deployment-url) || 'Preview deployment created successfully' }}

                      ---
                      *This comment will be automatically updated when new commits are pushed.*
