name: Test Preview Deployment

on:
  workflow_call:
    inputs:
      preview_url:
        description: 'Preview URL to test'
        required: true
        type: string


jobs:
  test-preview:
    name: Run Tests on Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract preview URL
        id: extract-url
        run: |
          PREVIEW_URL="${{ inputs.preview_url }}"
          
          echo "Preview URL: $PREVIEW_URL"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          
          # Validate URL format
          if [[ "$PREVIEW_URL" =~ ^https?:// ]]; then
            echo "url_valid=true" >> $GITHUB_OUTPUT
          else
            echo "url_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            chromium-browser \
            chromium-chromedriver \
            xvfb

      - name: Install dependencies
        run: npm ci

      - name: Create test environment file
        if: steps.extract-url.outputs.url_valid == 'true'
        run: |
          PREVIEW_URL="${{ steps.extract-url.outputs.preview_url }}"
          
          cat > tests/.env << EOF
          # The base URL that will be used for the test
          BASE_URL=${PREVIEW_URL}/meet/
          
          # Room name configuration
          ROOM_NAME_PREFIX=test
          ROOM_NAME_SUFFIX=grid
          
          # Browser configuration
          HEADLESS=true
          ALLOW_INSECURE_CERTS=true
          
          # Additional Chrome arguments for stability
          CHROME_ARGS=--disable-web-security --disable-features=VizDisplayCompositor --disable-background-timer-throttling --disable-backgrounding-occluded-windows --disable-renderer-backgrounding --disable-field-trial-config --disable-back-forward-cache --disable-ipc-flooding-protection --enable-features=NetworkService,NetworkServiceLogging --force-color-profile=srgb --metrics-recording-only --no-first-run --enable-automation --password-store=basic --use-mock-keychain --disable-extensions --disable-plugins --disable-default-apps --disable-sync --disable-translate --hide-scrollbars --mute-audio --no-sandbox --disable-dev-shm-usage --disable-setuid-sandbox --disable-gpu --disable-software-rasterizer --disable-background-networking --no-default-browser-check --no-pings --no-zygote --single-process
          
          # Video capture file (absolute path)
          VIDEO_CAPTURE_FILE=${{ github.workspace }}/tests/resources/fakeVideoStream.y4m
          
          # Test execution configuration
          MAX_INSTANCES=1
          
          # Domain resolution
          RESOLVER_RULES=MAP localhost 127.0.0.1
          EOF
          
          echo "Created tests/.env with BASE_URL: ${PREVIEW_URL}/meet/"

      - name: Run tests
        if: steps.extract-url.outputs.url_valid == 'true'
        continue-on-error: true
        run: |
          # Set display for headless Chrome
          export DISPLAY=:99
          Xvfb :99 -screen 0 1280x1024x24 &
          
          # Run tests
          npm run test
        env:
          DOTENV_CONFIG_PATH: tests/.env

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: |
            test-results/
            !test-results/allure-results/
          retention-days: 30

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.sha }}
          path: test-results/allure-report/
          retention-days: 30

      - name: Parse test results and create summary
        if: always()
        run: |
          echo "## üß™ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PREVIEW_URL="${{ steps.extract-url.outputs.preview_url }}"
          URL_VALID="${{ steps.extract-url.outputs.url_valid }}"
          
          if [ "$URL_VALID" != "true" ]; then
            echo "‚ùå **Status:** Failed - Invalid preview URL" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** Could not extract valid preview URL from deployment" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "‚úÖ **Status:** Tests completed" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** ${PREVIEW_URL}/meet/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Try to parse JUnit results if available
          if [ -f "test-results/results-0.xml" ]; then
            TESTS=$(grep -o 'tests="[0-9]*"' test-results/results-0.xml | grep -o '[0-9]*' || echo "unknown")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results/results-0.xml | grep -o '[0-9]*' || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' test-results/results-0.xml | grep -o '[0-9]*' || echo "0")
            
            echo "**Test Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Total Tests: $TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Failures: $FAILURES" >> $GITHUB_STEP_SUMMARY
            echo "- Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Note:** Detailed test results not available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Test Results: Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Allure Report: Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Tests run against preview deployment: ${PREVIEW_URL}/meet/*" >> $GITHUB_STEP_SUMMARY

      - name: Update PR comment with test results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-results
          message: |
            ## üß™ Test Results

            **Status:** ${{ steps.extract-url.outputs.url_valid == 'true' && '‚úÖ Tests completed' || '‚ùå Failed - Invalid preview URL' }}
            **Preview URL:** ${{ steps.extract-url.outputs.url_valid == 'true' && format('[{0}/meet/testmeeting1]({0}/meet/testmeeting1)', steps.extract-url.outputs.preview_url) || 'Preview URL not available' }}

            ${{ steps.extract-url.outputs.url_valid != 'true' && '**Reason:** Could not extract valid preview URL from deployment' || '' }}

            **Artifacts:**
            - [Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) - Download from workflow run
            - [Allure Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) - Download from workflow run

            ---
            *This comment will be automatically updated when new commits are pushed.*

